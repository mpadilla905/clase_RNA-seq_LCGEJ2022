<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>RNA-seq</title>
    <meta charset="utf-8" />
    <meta name="author" content="Mónica Padilla, Dra. Alejandra Medina" />
    <meta name="date" content="2022-03-03" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="slides_RNA-seq_files/extra.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# RNA-seq
## Bioformática - LCG-EJ
### Mónica Padilla, Dra. Alejandra Medina
### 2022-03-03

---




# Día 1

**Agenda:**

- Presentaciones y Lluvia de Ideas

- Overview RNA-seq
- Aspectos generales del Pre-Análisis
  - Diseño Experimental
  - Diseño de secuenciación
  
- Pipeline bioinformática
  - Quality Check
  - Trimming

- Ejercicio QC

---

# RNA-seq, ¿qué pensamos?

.scrollable[

**Actividad:** Lluvia de ideas

&lt;img style="border-radius: 90%; width: 150px; top: 1em; right: 1em; position:absolute;" src = "https://media.istockphoto.com/vectors/young-annoyed-female-character-sceptical-face-expression-vector-id1252249414?k=20&amp;m=1252249414&amp;s=612x612&amp;w=0&amp;h=l84MEu6X2KbrRnFbLS2KJ_dswLj0SPIp7pp__cXlRGM="&gt;

- Llenen en la siguiente tabla palabras clave sobre RNA-seq: https://docs.google.com/document/d/1pAFddzDlLrRvHMSUjddh7EG3PdTbob3g9UQWzMHXR-w/edit?usp=sharing

- Generemos una [figura de nuestras ideas](https://www.r-graph-gallery.com/wordcloud.html):





```r
library(wordcloud)
```

```
## Loading required package: RColorBrewer
```

```r
library(RColorBrewer)

words &lt;- c("Librería,","Secuenciación,","Transcripción,","samtools,","RNA,","","Regulación,","Nucleótido,","Traducción","RNA,","secuenciación,","proteínas,","regulación,","expresión","génica","Secuenciación,","expresión","diferencial,","transcriptoma,","fenotipos","exones","Transcriptoma,","expresión","diferencial,","RNA,","diferencia","celular","Transcripción,","regulación,","expresión,","muestra","Expresion,","exones,","transcriptoma,","UTR,","hisat2,","splicing,","Transcritoma,","splicing,","cDNA")

wordcloud(words, colors = RColorBrewer::brewer.pal(5,name = "BuPu"))
```

```
## Loading required namespace: tm
```

![](slides_RNA-seq_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;

]

---

# Transcriptómica

Estudio del **transcriptoma** - el set completo de transcritos de RNA producidos por el genoma bajo **condiciones específicas** o en una **célula específica** - usando métodos _high-throughput_.

- Identidad y abundancia

.container[
![](https://comunidadbioinfo.github.io/minicurso_abr_2021/Slides/Images/transcriptomica.png) [4]
]

???

o de alto rendimiento

- **¿Por qué la obsesión en el RNA?** Es un intermediario escencial entre el genoma y el proteoma. Entre lo pre-programado y la interacción con el ambiente. 

---

# ¿Qué es el RNA- seq?


![](https://comunidadbioinfo.github.io/minicurso_abr_2021/Slides/Images/book.png)

[4]

???

Herramienta que hace uso de las tecnologías de secuenciación NGS para generar perfiles transcriptómicos.

---

# Aplicaciones

![](img/RNA-seq_applications.png) [5]

???

Responder preguntas biológicas

---

# Bases de Datos

**Datos de publicación**

- NCBI
  - [Gene Expression Omnibus (GEO)](https://www.ncbi.nlm.nih.gov/geo/browse/)
  - Sequence Read Archive (SRA)
  
- EMBL-EBI
  - [ArrayExpress](https://www.ebi.ac.uk/arrayexpress/about.html)
  
**Consorcios **
  
- [Genotype Tissue-Expression (GTEx)](https://gtexportal.org/home/tissueSummaryPage)

- [The Cancer Genome Atlas (TCGA)](https://portal.gdc.cancer.gov/)

**Integración de datos para análisis**

- [recount3](https://rna.recount.bio/)

- [pulmonDB](https://pulmondb.liigh.unam.mx/)

---

# Aspectos generales del Pre Análisis

### Diseño Experimental y Diseño de Secuenciación

![](img/rna-seq_protocol.png) [1]

---

## Protocolo de extracción de RNA

**Propósito:** 
  
  Deshacerse del RNA ribosomal (90%) y quedarse con el mRNA (~1-2%)

.pull-left[
    
 - Eukaryotes
    - Enriquecer mRNAs usando selección de poly(A)
        - Degradación mínima del RNA, medido por _RNA Integrity Number (RIN)_

- Prokaryotes o _bad RIN_
    - Deshacerse del rRNA]
    
.pull-right[

![](https://sbi4u2013.files.wordpress.com/2013/02/cap-poly-a-tail.png)
]
    
---

### RNA world

- **lncRNA &amp; mRNA**: polyA selection

- **miRNA** : binding of 3'UTR target genes

- **sncRNA (miRNAs, piRNAs, and endosiRNAs)** : captured by direct ligation with adapters

- **circular RNA**: uso de exonuclease R para digerir RNA lineal

---

## Library Type

**La mejor opción:** depende del propósito del análisis

.pull-left[
- Single-end (SE)
    - Organismo bien documentado
    - Bajo costo
    
- Paired-end (PE) reads
    - Descubrimiento de transcritos _de novo_ 
    - Análisis de expresión de isoformas
    - Organismo no anotado
]

.pull-right[    
.fit[
![](img/reads_SE_PE_long.png) [2]
]]

---

## Sequencing Depth ó Library Size

`Número de secuenciación de lecturas para una muestra dada.`


**Mejor opción:** depende

- 5 millones de lecturas --&gt; Cuantificación adecuada de genes altamente expresados 

- 100 millones de lecturas --&gt; genes con niveles de expresión bajos

En general: 
`+ sequencing depth = + transcritos + precisión`
  
- Detección de ruido transcripcional

???

curvas de saturacion 

---

## Número de replicas

Depende de la variabilidad técnica y la variabilidad biológica del objeto de estudio, así como del poder estadístico deseado.

.pull-left[
- Variabilidad en mediciones
    - extracción o _library prep_
- Variabilidad biológica
    - Inferencias poblacionales: minimo 3
- Poder estadístico
    - Depende del método]

.pull-right[.fit[
![](img/nreplicates_statistical_power.png)
[1]
]]

---

# Diseño de Secuenciación

**Propósito:** Evitar introducir sesgos técnicos o factores de confusión en nuestras muestras.


&gt; Nuestro experimento de RNA-seq es grande y las muestras deben de ser procesadas en multiples _batches_ o rondas de secuenciación de Illumina

**Aleatorización de muestras**

- Durante preparación de librería
- Rondas de secuenciación

&gt; Muestras individualmente _barcoded_ y se requiren multiples _lanes_ de Illumina para _sequencing depth_ de nuestra elección

- Incluir todas las muestras en cada línea para minimizar el _lane effect_

???

- _spike-ins_ o transcritos exógenos de referencia
    - QC y normalización

---

# Pipeline bioinformática

.pull-left[
.container[
![](https://biocorecrg.github.io/RNAseq_course_2019/images/RNAseq_workflow.png)]
]

.pull-right[
[4]]
---

# Quality Check

Some tools:

- `FASTQC` Illumina reads
- `NGSQC` any platform
- `multiqc` : genera reportes gráficos con múltiples muestras

Revisar:

- Read quality decreases towards the 3' end of reads
- Niveles de k-meros, lecturas duplicadas, contenido de GC son experimento y organismo específicos pero deben ser homogeneos

---

# Trimming

Some tools: `FASTX-Toolkit`, `Trimmomatic`, `cutadapat`

Funciones:

- Quitar lecturas con mala calidad
- Quitar bases con baja calidad
- Cortar secuencias de adaptadores


---

# Ejercicio QC


![](img/multiqc.png)

---

# References

- [1] Conesa, A., Madrigal, P., Tarazona, S., … Mou, S. (2017). RNA-seq methods. Journal of Cellular Biochemistry, 8(1), 1–24. https://doi.org/10.1002/wrna.1364.RNA-Seq

- [2] Hrdlickova, R., Toloue, M., &amp; Tian, B. (2017). RNA‐Seq methods for transcriptome analysis. Wiley Interdisciplinary Reviews: RNA, 8(1), e1364.

- [3] Stark, R., Grzelak, M., &amp; Hadfield, J. (2019). RNA sequencing: the teenage years. Nature Reviews Genetics, 20(11), 631-656.

- [4] Villaseñor-Altamirano, A. B. &amp; Chávez-Domínguez, R. L. "Mini curso abril 2021: Panorama general de análisis de datos de RNA-seq con R". Red Mexicana de Bioinformática (2021). https://comunidadbioinfo.github.io/minicurso_abr_2021/

- [5] Created with BioRender.com

---

# Día 2

.scrollable[

**Agenda:**

- Caso de estudio, pipeline so far, revisión QC

- In-depth Pipeline bioinformática
  - Alineamiento, Pseudoalineamiento y Conteo
  - Visualizacion de reads en IGV
  - Algoritmos de programas famosos
  - Ejercicio: pseudo-alineamiento con `kallisto`

]

??

¿Cómo tengo certeza de que mi gen no es un artefacto?

---

# Caso de estudio: BRAF inhibition in melanoma cell lines

.scrollable[
Número de acceso GEO: [GSE152699](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE152699)

![](img/caso_estudio.png)

_image from (Villaseñor-Altamirano AB, 2021)_

[SRA Run Selector: SRP267712](https://www.ncbi.nlm.nih.gov/Traces/study/?acc=PRJNA640146&amp;o=acc_s%3Aa) :

![](img/sra-run-selector.png)

.red[Nota:] Notemos que cada una de las runs o tandas de secuenciación (identificadas con `SRR`), corresponden a una muestra biológica o réplica (identificadas con `SAMN`).

.
.
.
.

]

---

# Pipeline so far

.scrollable[

```bash
screen -S data
qlogin
umask 2 # permisos
cd mpadilla/clases/rnaseq # change to yours
```

- Obtener archivos fastq


```bash
module load e-utilities/27abr20
module load sra/2.9.6-1
vdb-config -i # disable storage of cache in ~
mkdir -p data/fastq
```

That opens an interface, press `2` (disable local file caching) &gt; `6` (save) &gt; `7` (exit).


```bash
# Get SRR accessions, then download fastq files
esearch -db sra -query "SRP267712" |  efetch -format docsum | xtract -pattern Runs -ACC @acc  -element "&amp;ACC" | xargs fastq-dump --outdir ./data/fastq --gzip --split-3
mv *.fastq.gz data/fastq # move fastq files to their dir
```

- QC

current dir = `[mpadilla/clases/rnaseq]`


```bash
module load fastqc/0.11.3
fastqc ./data/fastq/*.fastq.gz -o ./out/QC
```


- Trimming

Correr iterativamente trimmomatic


```bash
mkdir out/trimmed
cd out/trimmed
module load trimmomatic/0.33
for file in ../../data/fastq/*1.fastq.gz; do trimmomatic PE -phred33 -basein $file -baseout ${file//_1.fastq/_trmd_1.fastq} ILLUMINACLIP:/mnt/Citosina/amedina/mpadilla/resources/trimmomatic/adapters/TruSeq3-PE.fa:2:30:10 SLIDINGWINDOW:5:30 MINLEN:40; done
cd ../..
```

Adapters file downloaded from: https://github.com/timflutre/trimmomatic/blob/master/adapters/TruSeq3-PE.fa, [HiSeq uses TruSeq3 adapters as indicated in trimmomatic manual](http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf).

- QC


```bash
mkdir out/QC2
fastqc ./out/trimmed/*.fastq.gz -o ./out/QC2
```

- Reporte multiqc


```bash
module load multiqc/1.5
multiQC ./out/QC2
pwd
```

- See file

In local:


```bash
rsync -rptuvl mpadilla@dna.liigh.unam.mx:/mnt/Citosina/amedina/mpadilla/clases/rnaseq/out/QC2/multiqc_report.html . # descargar
xdg-open multiqc_report.html # abrir archivo
```


]

---

# Pipeline: Dónde estamos

.container[
![](https://comunidadbioinfo.github.io/minicurso_abr_2021/Slides/Images/RNAseq_workflow2.png)
]

---

# Alineamiento

![](https://comunidadbioinfo.github.io/minicurso_abr_2021/Slides/Images/ReadAlignment.png)

---

# Alineamiento y Conteo

¿Cómo saber qué tipo de algoritmo usar?

![](img/alineamiento.png)

---

# Alineamiento con referencia

.pull-left[
![](img/alineamiento_referencia.png)
]

.pull-right[
- ¿Encontrar nuevos transcritos o sólo cuantificar?
  - PE y alta cobertura
  
- Mapeo singular o múltiple de lecturas
  - Secuencias repetidas en el genoma, genes paralogos
  - Mayor mapeo múltiple con transcriptoma debido a isoformas
]

---

### Genoma de referencia

![](img/alineamiento_ref_splicing.png)

_image from (Villaseñor-Altamirano AB, 2021)_

---

### Ejemplos genoma de referencia

_ _splicing aware__ : Hacen gaps en los reads al compara con el genoma de referencia

.container[
![](img/hisat_star_tophat2png)]

_image from (Villaseñor-Altamirano AB, 2021)_

---

![](img/rna-seq_igv.png)

---

### Ejemplo transcriptoma de referencia

Programa `kallisto`

- Precisos al caracterizar transcritos con alta abundancia, menos precisos con transcritos con menos o cortos

.fit[
![](https://media.springernature.com/full/springer-static/image/art%3A10.1038%2Fnbt.3519/MediaObjects/41587_2016_Article_BFnbt3519_Fig1_HTML.jpg?as=webp)]

---

# Ensamblaje de novo

.pull-left[
- Uso de PE o lecturas largas

- Balance en cobertura
    - Transcritos de baja expresión: unreliable
    - Mucha cobertura: potencial ensamblaje erróneo y mayor tiempo de ejecución
    
- Combinar reads de todas las muestras para el ensamblaje --&gt; comparaciones adecuadas
]

.pull-right[
.container2[
![](img/denovo_assembly.png)
]]

---

# Cuantificación de transcritos

.scrollable[
- Enfoque simple: número de reads que mapearon a cada secuencia
    - `HTSeq-count`, `featureCounts`
      - Gene-level =&gt; gene transfer format (GTF)
    - `Cufflinks`: PE, GTF o no, toma en cuenta sesgos de longitud de genes, distribución de reads

- `sailfish` : k-meros de reads

- ¿Cómo sé que mis cuentas corresponden a genes/transcritos?
  - Referencia con anotaciones
  - [GENCODE](https://www.gencodegenes.org/mouse/)
  - [Ensembl](https://www.ensembl.org/info/data/ftp/index.html)

`output` : **Cuentas crudas** o _raw counts_
¿Ya puedo comparar mis niveles de expresión en mi experimento?

]

---

# Ejercicio: 

.scrollable[
### Alineamiento y conteo usando [`kallisto`][kallisto]

.red[ Nota:] cualquier línea de código encerrada en `[]` es opcional o debe cambiarse para tus paths o caso especfíco.

Ir a mi directorio en el cluster:


```bash
ssh -Y mpadilla@[direccion]
cd [/path/a/mi/dir]/mpadilla/
# ir al directorio del proyecto o la clase
cd [clases/rnaseq/]
```


Descargar [transcriptoma de referencia de ratón de GENCODE](https://www.gencodegenes.org/mouse/):


```bash
mkdir resources; cd resources
wget https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M28/gencode.vM28.transcripts.fa.gz
cd .. # regresar a rnaseq
```

Hacer índice del transcriptoma de referencia que hicimos con GENCODE:

- Ver ayuda en [manual de kallisto][kallisto] o en terminal ( `kallisto index -h` )


```bash
module load kallisto/0.45.0 # cargar modulo de kallisto
kallisto index -i index_kallisto45_gencode-m28s gencode.vM28.transcripts.fa.gz
cd .. # salimos del dir resources
```

* `-i` nombre de archivo de salida, i.e., indice

Hacer liga blanda a archivos fastq ya corregidos con trimming:


```bash
#ln -rs /mnt/Citosina/amedina/mpadilla/clases/rnaseq/out/trimmed [path/a/tu/dir/]out/
```

* .red[_Nota:_ ]en clase vimos que no podemos hacer esto si no tenemos permisos. Los datos se copiaron a `/mnt/Timina/bioinfoII/rnaseq/trimmed`

Hacer el conteo de transcritos ocupando el índice que hicimos:


```bash
mkdir out/kallisto # usar -p si no existe out aun
*kallisto quant -i ./resources/index_kallisto45_gencode-m28 -o ./out/kallisto /mnt/Timina/bioinfoII/rnaseq/trimmed/* # once per sample!!
```

* `-o` dir donde colocar output de kallisto

- .red[La última línea está mal!] Ahí le estamos diciendo a `kallisto quant` que haga la cuantificación de transcritos con TODOS los archivos fastq, i.e. de todas las muestras juntas, por lo que las cuentas de controles y casos (M14 con BRAF ihnibido o no) estarán combinadas y no podremos hacer comparaciones

Para correr `kallisto quant` POR muestra (`SAMN`, recordemos que en este caso cada run `SRR*.fastq` corresponde a una muestra), hagamos lo siguiente:


```bash
cd out/kallisto
# 1. Hacer dirs de salida para kallisto por muestra:
ls ../trimmed/ | perl -pe 's/(SRR\d+)_trmd.*/mkdir $1/' | uniq # copiar texto y pegar en terminal
```

```
mkdir SRR12038081
mkdir SRR12038082
mkdir SRR12038083
mkdir SRR12038084
mkdir SRR12038085
mkdir SRR12038086
```

* `ls ../trimmed/` : vemos archivos fastq, identificados por SRR
* `perl -pe 's/[match]/[substitution]/'` : con este formato llamamos a perl, `-pe` le dice que corra el siguiente código tomando como input cada línea del STDIN, `s/[match]/[substitution]/` denotamos una subtitución usando expresiones regulares, `(SRR\d+)_trmd.*` guardamos los ids con `()` y seleccionamos el resto, substituimos el texto por `mkdir $1` donde $1 es la variable que guardamos


```bash
# 2. Generar lineas para correr kallisto por muestra, ocupando el id SRR como identificador de archivos fastq y dirs
ls | grep "SRR" | perl -pe 's/(SRR\d+)/kallisto quant -i ..\/..\/resources\/index_kallisto45_gencode-m28 -o .\/$1 ..\/trimmed\/$1* /' 
# cambiar archivo en -i por el path a tu indice
```

```
kallisto quant -i ../../resources/index_kallisto45_gencode-m28 -o ./SRR12038081 ../trimmed/SRR12038081* 
kallisto quant -i ../../resources/index_kallisto45_gencode-m28 -o ./SRR12038082 ../trimmed/SRR12038082* 
kallisto quant -i ../../resources/index_kallisto45_gencode-m28 -o ./SRR12038083 ../trimmed/SRR12038083* 
kallisto quant -i ../../resources/index_kallisto45_gencode-m28 -o ./SRR12038084 ../trimmed/SRR12038084* 
kallisto quant -i ../../resources/index_kallisto45_gencode-m28 -o ./SRR12038085 ../trimmed/SRR12038085* 
kallisto quant -i ../../resources/index_kallisto45_gencode-m28 -o ./SRR12038086 ../trimmed/SRR12038086*
```

* `grep` selecciona lineas de STDIN o texto que hagan match 
* con perl escribimos las lineas para correr kallisto usando el string de las SRR ids al que hicimos match
* `../trimmed/SRR12038081*` esta parte tomará las reads a las que hicimos trimmming; como los datos provienen de PAIRED END, son un fastq por cada end (`SRR_trmd_1.fastq` y `SRR_trmd_2.fastq`).

_Nota:_ Otra manera de lidear con múltiples archivos, que generen múltiples archivos de salida y que necesitamos para correr en una pipeline es usando `snakemake` o `makefiles` en `bash`

Pegar ese output siguiente al sge (`[quant.sge]`) y hacer `qsub quant.sge`


```bash
#!/bin/bash
# Use current working directory
#$ -cwd
#
# Join stdout and stderr
#$ -j y
#
# Run job through bash shell
#$ -S /bin/bash
#
#You can edit the scriptsince this line
#   
# Your job name
*#$ -N [quant] # cambiar
#
# Send an email after the job has finished
#$ -m e
*#$ -M [yourmail]
#
#
# If modules are needed, source modules environment (Do not delete the next line):
. /etc/profile.d/modules.sh
#
# Add any modules you might require:
*module load kallisto/0.45.0
#
# Write your commands in the next line
kallisto quant -i index_kallisto45_gencode-m28 -o ./SRR12038081 ../trimmed/SRR12038081* 
kallisto quant -i index_kallisto45_gencode-m28 -o ./SRR12038082 ../trimmed/SRR12038082* 
kallisto quant -i index_kallisto45_gencode-m28 -o ./SRR12038083 ../trimmed/SRR12038083* 
kallisto quant -i index_kallisto45_gencode-m28 -o ./SRR12038084 ../trimmed/SRR12038084* 
kallisto quant -i index_kallisto45_gencode-m28 -o ./SRR12038085 ../trimmed/SRR12038085* 
kallisto quant -i index_kallisto45_gencode-m28 -o ./SRR12038086 ../trimmed/SRR12038086*
```

![](img/rna-icon.png)

]

---


---

# Día 3

**Agenda:**

- Pipeline: Dónde estamos

- Importación e integración de datos
  - Ejercicio

- Normalización

- Corrección de _batches_
  - Exploración de datos con PCA

---

# Preguntas

- The GFF3 (General Feature Format) format consists of one line per feature, each containing 9 columns of data . [see more](http://www.ensembl.org/info/website/upload/gff3.html)

- The GTF (General Transfer Format) is identical to GFF version 2. [see more](http://www.ensembl.org/info/website/upload/gff.html)

- GitHub Max Storage (FREE) : 2GB

.container[
![](https://www.researchgate.net/profile/Julita-Kulbacka/publication/325794199/figure/fig2/AS:637892296728576@1529096783673/Scheme-2-Vemurafenib-and-dabrafenib-mechanism-of-action-Modified-from-R-Fisher-and.png)
]

---

# Pipeline: Dónde estamos

.scrollable[
![](img/RNAseq_workflow_add.png)

_modified from (Villaseñor-Altamirano AB, 2021)_

Nuestro proyecto se ve algo así hasta ahora:

![](img/terminal_dia3.png)

Ver archivo:


```bash
cd /mnt/Timina/bioinfoii/rnaseq
less out/kallisto/SRR12038081/abundance.tsv
```


]

???

* `abundances.h5` is a HDF5 binary file containing run info, abundance esimates, bootstrap estimates, and transcript length information length.
* `abundances.tsv` is a plaintext file of the abundance estimates. It does not contains bootstrap estimates. The first line contains a header for each column, including estimated counts, TPM, effective length.

    + `target_id` = transcript id, cambia dependiendo del archivo de anotacion
    + `length` 
    + `eff_length` = effective length
    + `est_counts` = estimated counts
    + `tpm` = Transcripts per million (TPM) is a measurement of the proportion of transcripts in your pool of RNA.

* `run_info.json` is a json file containing information about the run. We can facilitate further work by saving this files in a dir with the SRA ID name.

---

# Importación e Integración de datos

.scrollable[
![](img/counts-matrix.png)

Paquetes bioconductor: `tximeta` y [`tximport`](https://bioconductor.org/packages/devel/bioc/vignettes/tximport/inst/doc/tximport.html)

![](img/CVpyU2pWcAIwJAl.png)
]

---

# Ejercicio

.scrollable[

**Summarizing to gene level from transcript abundance with `tximport`**


```bash
screen -S txi
qlogin
cd [su/path/en/cluster]
cd out/kallisto/
module load r/4.0.2
R
```

En R:


```r
library(tximport)
library(tidyverse) # stringr

# Load data
files &lt;- file.path("/mnt/Timina/bioinfoII/rnaseq/out/kallisto",list.dirs(dir(".")),"abundance.h5") # abundance files paths
names(files) &lt;- str_extract(files,"SRR\\d+") # so that tximport identifies them
files
```
```
                                                         SRR12038081 
"/mnt/Timina/bioinfoII/rnaseq/out/kallisto/SRR12038081/abundance.h5" 
                                                         SRR12038082 
"/mnt/Timina/bioinfoII/rnaseq/out/kallisto/SRR12038082/abundance.h5" 
                                                         SRR12038083 
"/mnt/Timina/bioinfoII/rnaseq/out/kallisto/SRR12038083/abundance.h5" 
                                                         SRR12038084 
"/mnt/Timina/bioinfoII/rnaseq/out/kallisto/SRR12038084/abundance.h5" 
                                                         SRR12038085 
"/mnt/Timina/bioinfoII/rnaseq/out/kallisto/SRR12038085/abundance.h5" 
                                                         SRR12038086 
"/mnt/Timina/bioinfoII/rnaseq/out/kallisto/SRR12038086/abundance.h5"
```


```r
# Load table with trx id and gene id corrspondence
tx2gene &lt;- read.csv("/mnt/Timina/bioinfoII/rnaseq/resources/gencode/gencode.vM28.basic.trx_id-gene_id-no_ver.tsv",stringsAsFactors = F)
# Load table with trx id and gene name corrspondence
tx2genename &lt;- read.csv("/mnt/Timina/bioinfoII/rnaseq/resources/gencode/gencode.vM28.basic.trx_id-gene_name-no_ver.tsv",stringsAsFactors = F)

# Run tximport
# tx2gene links transcript IDs to gene IDs for summarization
txi.kallisto &lt;- tximport(files, type = "kallisto", tx2gene = tx2gene, ignoreAfterBar=TRUE, ignoreTxVersion=TRUE)
txi.kallisto.name &lt;- tximport(files, type = "kallisto", tx2gene = tx2genename, ignoreAfterBar=TRUE, ignoreTxVersion=TRUE)
```
```
1 2 3 4 5 6 
removing duplicated transcript rows from tx2gene
transcripts missing from tx2gene: 92813
summarizing abundance
summarizing counts
summarizing length
```


```r
names(txi.kallisto)
```
```
[1] "abundance"           "counts"              "length"             
[4] "countsFromAbundance"
```

```r
head(txi.kallisto$counts)
```
```
                   SRR12038081 SRR12038082 SRR12038083 SRR12038084 SRR12038085
ENSMUSG00000000001   130.00000    73.00000    53.00000          60   96.000000
ENSMUSG00000000056     0.00000     0.00000     0.00000           0    0.000000
ENSMUSG00000000058     2.00000     1.00000     2.00000           2    4.000000
ENSMUSG00000000078    13.58842    13.58842    12.22958           9    4.076527
ENSMUSG00000000088    81.00000    43.00000    38.00000          31   47.000000
ENSMUSG00000000093    15.00000    11.00000     8.00000           7   12.000000
                   SRR12038086
ENSMUSG00000000001    98.00000
ENSMUSG00000000056     0.00000
ENSMUSG00000000058     0.00000
ENSMUSG00000000078     5.43537
ENSMUSG00000000088    70.00000
ENSMUSG00000000093    15.00000
```

transcript estimatio--&gt; read counts

]

---

# Normalización

### ¿Por qué es necesario normalizar?

Nuestros datos están sujetos a **sesgos técnicos y biológicos** que provocan variabilidad en las cuentas.

Si queremos hacer **comparaciones de niveles de expresión entre muestras** es necesario ajustar los datos tomando en cuenta estos sesgos.

- Análisis de expresión diferencial
- Visualización de datos
- en general, siempre que estemos comparando expresión


### ¿Qué es normalizar en sí?

El proceso de ajuste de las cuentas (scaling factors) por los sesgos "no interesantes" de varibialidad.

???

Comparar niveles de expresión entre genes y entre muestras.


- Las cuentras crudas no son adecuadas para comparar entre muestras
  - Gene/transcript length
  - Número total de reads
  - Sesgos de secuenciación
  
- Normalización _within-sample_
  - Tamaño de librería: Número de secuenciación de lecturas para una muestra dada

---

## Criterios o sesgos a considerar

- Pueden ser relevantes para la comparacion de la expresión .red[entre muestras distintas] (eg muestra control vs muestra caso) y/o .red[dentro de una misma muestra] muestras (entre genes).

- __Sequencing depth__ : En este caso, cada gen parece expresarse el doble cuando comparamos `Sample A` vs `Sample B`, sin embargo, sólo parece a sí porque la `Sample A` tuvo el doble de secuenciación
 
  - .red[entre muestras distintas]

.fit[  
![](https://hbctraining.github.io/DGE_workshop/img/normalization_methods_depth.png)
]

---

## Criterios o sesgos a considerar

- __Sequencing depth__ 

  - **Método:** Dividir por el size factor

![](img/normalization_sequencing-depth.png)

---

## Criterios o sesgos a considerar

.pull-left[
- __Gene length__ : El `Gene X` y el `Gene Y` tienen tienen niveles similares de expresión pero el número de lecturas mapeadas será mayor en el `Gen X` porque es más largo.

  - .red[misma muestra]
  - Método: dividir por el largo del gen
]


.pull-right[
.fit[
![](https://hbctraining.github.io/DGE_workshop/img/normalization_methods_length.png)
]
]

---

## Criterios o sesgos a considerar

.pull-left[
- __Composición de RNA__ : Si normalizamos dividiendo las cuentas entre el numero total de cuentas en cada muestra, el resto de los genes en la Sample A se verán ampliamente afectados por el Gene DE

  - .red[entre muestras distintas]

  - Genes altamente diferencialmente expresados 
  
  - Diferencias en el número de genes expresados -- PCR
  
  - Contaminación
  
]

.pull-right[.fit[
![](https://hbctraining.github.io/DGE_workshop/img/normalization_methods_composition.png)]
]

---

.scrollable[
![](img/metodos_normalizacion.png)]

---

# Correción por _batch effect_

**Mal diseño experimental  ==&gt;  Mucho _batch effect_**

- En este caso no se podría tener certeza sobre ningún resultado

![](img/exp-design_malo_batcheffect.png)

---

# Correción por _batch effect_

**Buen diseño experimental, pero aun puede haber variación técnica**

![](img/exp-design_bueno.png)

---

# Correción por _batch effect_

¡Pero no todo está perdido!

![](img/batch_correction.png)

---

# Métodos para RNA-seq

.scrollable[
- `edgeR`
- `ComBat -batch`
- `ComBat_seq -batch -bio_conditions` :
    - Supone una binomial negativa


![](https://oup.silverchair-cdn.com/oup/backfile/Content_public/Journal/nargab/2/3/10.1093_nargab_lqaa078/2/m_lqaa078fig4.jpeg?Expires=1649082255&amp;Signature=RLNrzqhL4-ZpE8QDLsJGDvQQH2hVs7x~rRTl4VbfKkBQg-n16PrOm2FYv90qNcW4il~mNDlFiduXI4ygNQzYBeWUIld18CdV1BEYbQeCVAT1vp2AtVA01sM0mTv6ZquaanL2sGpqY5gy~T736gq~PQs4YxuS1PcZOphkD840zB-Mbla3u5ZMezryTDAmQk4aMOWkJ7-Lpi-UCuy7RtefhPIniVILFZl4lSKNP8BStcKn6cYWA8UuxFo6vX5FfozExtkGtVLFGw4D0~j7uC0~~gXT9QR8vfkcIGfM2VMwMmbg~D0mndScujE0WTrct61LEuFm0N6zGZe9xFR17GfiOw__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA)

]

---

# Visualización con datos reales

![](https://www.biorxiv.org/content/biorxiv/early/2017/10/09/200345/F3.large.jpg?width=800&amp;height=600&amp;carousel=1)

- Balance entre integración de datasets para ganar poder estadístico y la capacidad de los algoritmos por deshacerse del _batch effect_

---

# Referencias

- https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html
- combat

[kallisto]:https://pachterlab.github.io/kallisto/manual
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<style>
  .logo {
    background-image: url(img/rna-icon.png);
    background-size: contain;
    background-repeat: no-repeat;
    position: absolute;
    top: 1em;
    right: 1em;
    width: 73px;
    height: 86px;
    z-index: 0;
  }
</style>
  
  <script>
  document
.querySelectorAll(
  '.remark-slide-content' +
    ':not(.title-slide)' +
    // add additional classes to exclude here, e.g.
  // ':not(.inverse)' +
    ':not(.hide-logo)'
)
.forEach(el => {
  el.innerHTML += '<div class="logo"></div>';
});
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
